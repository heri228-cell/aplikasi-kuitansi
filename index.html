<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Cetak Kuitansi BPU</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        :root { --primary: #0d6efd; --bg: #f4f6f8; --text: #212529; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* LAYAR LOGIN (FULL SCREEN) */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0d6efd, #0043a8);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px; text-align: center; width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .login-card h3 { margin-top: 0; color: #333; }
        .login-card input { 
            width: 100%; padding: 12px; margin: 20px 0; border: 2px solid #eee; 
            border-radius: 8px; font-size: 18px; text-align: center; letter-spacing: 4px; outline: none;
        }
        .login-card input:focus { border-color: var(--primary); }
        .login-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none; 
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .login-btn:hover { opacity: 0.9; }
        .error-msg { color: red; margin-top: 10px; font-size: 0.9rem; display: none; }

        /* APP CONTAINER (HIDDEN SAAT BELUM LOGIN) */
        #app-container { display: none; max-width: 850px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* HEADER */
        .app-header { background: #0d6efd; color: white; padding: 20px; text-align: center; position: relative; }
        .header-btn { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .btn-small { background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .btn-small:hover { background: rgba(255,255,255,0.3); }
        
        /* FORM STYLE */
        .form-body { padding: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .input-group { display: flex; gap: 5px; }
        .btn-search { background: #e7f1ff; color: var(--primary); border: 1px solid #b6d4fe; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-save { width: 100%; background: #198754; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .loading { display: none; text-align: center; margin-top: 10px; color: var(--primary); font-weight: bold; }

        /* Select2 Fix */
        .select2-container { width: 100% !important; }
        .select2-container .select2-selection--single { height: 42px !important; padding: 6px; border: 1px solid #ddd; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 40px !important; }

        /* PRINT CSS */
        #print-area { display: none; }
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white; padding: 0; font-family: 'Times New Roman', serif; }
            #login-overlay, #app-container { display: none !important; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; font-size: 12pt; color: black; line-height: 1.5; }
            .header { text-align: center; font-weight: bold; text-decoration: underline; margin-bottom: 40px; font-size: 14pt; }
            .row { display: flex; margin-bottom: 18px; }
            .label { width: 160px; flex-shrink: 0; } .separator { width: 20px; flex-shrink: 0; text-align: center; } .value { flex: 1; text-align: justify; }
            .ttd-container { margin-top: 80px; display: flex; justify-content: space-between; text-align: center; width: 100%; font-size: 10pt; }
            .nowrap-text { white-space: nowrap; }
            .ttd-box-left { width: 22%; padding-right: 2px; } .ttd-box-center { width: 44%; padding: 0 2px; } .ttd-box-right { width: 34%; padding-left: 2px; }
            .bold { font-weight: bold; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
            <h3>Akses Terbatas</h3>
            <p>Masukkan PIN Keamanan</p>
            <form onsubmit="prosesLogin(event)">
                <input type="password" id="pin" placeholder="PIN" required autofocus>
                <button type="submit" class="login-btn" id="btnLogin">MASUK</button>
            </form>
            <div class="error-msg" id="loginError">PIN Salah!</div>
        </div>
    </div>

    <div id="app-container">
        <div class="app-header">
            <div class="header-btn">
                <button class="btn-small" onclick="forceSync()">üîÑ Sync</button>
                <button class="btn-small" onclick="doLogout()" style="background: rgba(255,0,0,0.3);">üö™ Logout</button>
            </div>
            <h2>Aplikasi Kuitansi BPU</h2>
            <p id="statusInfo">Memuat...</p>
        </div>

        <div class="form-body">
            <form id="kuitansiForm" onsubmit="handleForm(event)">
                <div class="form-group">
                    <label>No. Bukti</label>
                    <div class="input-group">
                        <input type="text" name="no_bukti" id="no_bukti" placeholder="..." required style="font-weight: bold;">
                        <button type="button" class="btn-search" onclick="cariData()">üîç Cari</button>
                    </div>
                </div>

                <div class="form-group"><label>Kegiatan</label><select id="kode_kegiatan" name="kode_kegiatan" class="select2-enable" required><option></option></select></div>
                <div class="form-group"><label>Kode Barang</label><select id="kode_barang" name="kode_barang" class="select2-enable" required><option></option></select></div>
                
                <div class="form-group"><label>Terima Dari</label><input type="text" name="terima_dari" id="terima_dari" value="Kepala Sekolah SMPN 2 Kejayan Kecamatan Kejayan"></div>
                <div class="form-group"><label>Nominal (Rp)</label><input type="number" name="nominal" id="nominal" onkeyup="updateTerbilang()" placeholder="0" required></div>
                <div class="form-group"><label>Terbilang</label><input type="text" name="terbilang" id="terbilang" readonly style="background: #eee;"></div>
                <div class="form-group"><label>Untuk Pembayaran</label><textarea name="untuk_pembayaran" id="untuk_pembayaran" rows="3" required></textarea></div>
                <div class="form-group"><label>Tanggal Lunas</label><input type="date" name="tanggal_lunas" id="tanggal_lunas" required></div>
                
                <hr>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1"><label>Kepala Sekolah</label><input type="text" id="input_nama_kepala" readonly><input type="hidden" id="input_nip_kepala"></div>
                    <div class="form-group" style="flex:1"><label>Bendahara</label><input type="text" id="input_nama_bendahara" readonly><input type="hidden" id="input_nip_bendahara"></div>
                </div>
                <div class="form-group"><label>Penerima</label><select id="nama_penerima" name="nama_penerima" class="select2-penerima" required><option></option></select></div>

                <button type="submit" class="btn-save">Simpan Data & Cetak</button>
                <p class="loading" id="loadingText">Menyimpan...</p>
            </form>
        </div>
    </div>

    <div id="print-area">
        <div class="header">BUKTI PEMBAYARAN</div>
        <div class="row"><div class="label">No</div><div class="separator">:</div><div class="value" id="p_no"></div></div>
        <div class="row"><div class="label">Kegiatan</div><div class="separator">:</div><div class="value">BELANJA OPERASIONAL SEKOLAH (BOS)</div></div>
        <div class="row"><div class="label">Kode Kegiatan</div><div class="separator">:</div><div class="value" id="p_kegiatan_kode"></div></div>
        <div class="row"><div class="label">Kode Barang</div><div class="separator">:</div><div class="value" id="p_barang"></div></div>
        <br>
        <div class="row"><div class="label">Terima Dari</div><div class="separator">:</div><div class="value" id="p_terima"></div></div>
        <div class="row"><div class="label">Sebesar</div><div class="separator">:</div><div class="value" style="font-weight: bold;">Rp <span id="p_nominal" style="margin-left: 5px;"></span></div></div>
        <div class="row"><div class="label">Terbilang</div><div class="separator">:</div><div class="value" id="p_terbilang" style="font-style: italic;"></div></div>
        <div class="row"><div class="label">Untuk</div><div class="separator">:</div><div class="value" id="p_untuk"></div></div>
        <div class="ttd-container">
            <div class="ttd-box-left"><div>Setuju Dibayar,</div><div>Kepala SMPN 2 Kejayan</div><div style="height:75px;"></div><div class="bold nowrap-text" style="text-decoration: underline;" id="lbl_nama_kepala"></div><div class="nowrap-text" id="lbl_nip_kepala"></div></div>
            <div class="ttd-box-center"><div class="nowrap-text">Lunas dibayar Tanggal, <span id="p_tgl_1"></span></div><div>Bendahara BOS</div><div style="height:75px;"></div><div class="bold nowrap-text" style="text-decoration: underline;" id="lbl_nama_bendahara"></div><div class="nowrap-text" id="lbl_nip_bendahara"></div></div>
            <div class="ttd-box-right"><div class="nowrap-text">Kab. Pasuruan, <span id="p_tgl_2"></span></div><div>Yang Menerima</div><div style="height:75px;"></div><div class="bold" id="p_penerima" style="text-transform: uppercase;"></div></div>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const API_URL = "https://script.google.com/macros/s/AKfycbxpG5QV91fNjCNytxF5rJaLS9SZXCvw84syncm43jPb4v9etl5YXjS__XUv13vreix9vA/exec"; 
        const CACHE_KEY = "kuitansi_data_v2";
        let USER_TOKEN = ""; // Kunci rahasia yang disimpan di memori browser

        let defaultTerimaDari = "Kepala Sekolah SMPN 2 Kejayan Kecamatan Kejayan";

        window.onload = function() {
            document.getElementById('tanggal_lunas').valueAsDate = new Date();
            
            // 1. CEK APAKAH SUDAH LOGIN SEBELUMNYA?
            let savedToken = sessionStorage.getItem("app_token");
            if (savedToken) {
                // Kalau ada, langsung masuk
                USER_TOKEN = savedToken;
                showApp();
                loadData(true);
            }
        };

        // --- SISTEM LOGIN ---
        function prosesLogin(e) {
            e.preventDefault();
            let pin = document.getElementById('pin').value;
            let btn = document.getElementById('btnLogin');
            btn.innerText = "Memeriksa..."; btn.disabled = true;

            // Cek ke Server apakah PIN benar?
            fetch(API_URL + "?password=" + encodeURIComponent(pin))
            .then(res => res.json())
            .then(data => {
                if (data.result === "error") {
                    document.getElementById('loginError').style.display = "block";
                    btn.innerText = "MASUK"; btn.disabled = false;
                } else {
                    // Login Sukses
                    USER_TOKEN = pin;
                    sessionStorage.setItem("app_token", pin); // Simpan sesi (hilang kalau browser ditutup)
                    showApp();
                    isiDropdown(data);
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                }
            })
            .catch(err => {
                alert("Gagal koneksi internet.");
                btn.innerText = "MASUK"; btn.disabled = false;
            });
        }

        function doLogout() {
            sessionStorage.removeItem("app_token"); // Hapus sesi
            location.reload(); // Refresh halaman -> Kembali ke Login
        }

        function showApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        // --- DATA LOADING & SYNC ---
        function loadData(isCached) {
            let localData = localStorage.getItem(CACHE_KEY);
            if (localData) {
                isiDropdown(JSON.parse(localData));
                document.getElementById('statusInfo').innerText = "Data Siap (Cache)";
            }
            forceSync(); // Update background
        }

        function forceSync() {
            document.getElementById('statusInfo').innerText = "Sinkronisasi...";
            // Sertakan Password di setiap request
            fetch(API_URL + "?password=" + encodeURIComponent(USER_TOKEN))
            .then(res => res.json())
            .then(data => {
                if (data.result === "error") return; // Auth gagal
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                isiDropdown(data);
                document.getElementById('statusInfo').innerText = "Data Terupdate.";
            });
        }

        // --- FUNGSI ISI DROPDOWN & FORM ---
        function isiDropdown(data) {
            if (data.nextNo && !document.getElementById('no_bukti').value) {
                document.getElementById('no_bukti').value = data.nextNo;
            }

            // Simpan state dropdown agar tidak reset saat sync
            let curKeg = $('#kode_kegiatan').val();
            let curBar = $('#kode_barang').val();
            let curPen = $('#nama_penerima').val();

            let selKeg = $('#kode_kegiatan').empty().append('<option></option>');
            let selBar = $('#kode_barang').empty().append('<option></option>');
            let selPen = $('#nama_penerima').empty().append('<option></option>');

            if(data.kegiatan) data.kegiatan.forEach(x => selKeg.append(new Option(x, x)));
            if(data.barang) data.barang.forEach(x => selBar.append(new Option(x, x)));
            if(data.penerima) data.penerima.forEach(x => selPen.append(new Option(x, x)));

            $('.select2-enable').select2({ placeholder: "Cari...", allowClear: true, width: '100%' });
            $('.select2-penerima').select2({ placeholder: "Pilih / Ketik Baru", allowClear: true, tags: true, width: '100%' });

            if(curKeg) $('#kode_kegiatan').val(curKeg).trigger('change');
            if(curBar) $('#kode_barang').val(curBar).trigger('change');
            if(curPen) $('#nama_penerima').val(curPen).trigger('change');

            if(data.pejabat) {
                document.getElementById('input_nama_kepala').value = data.pejabat.kepala.nama;
                document.getElementById('input_nip_kepala').value = data.pejabat.kepala.nip;
                document.getElementById('input_nama_bendahara').value = data.pejabat.bendahara.nama;
                document.getElementById('input_nip_bendahara').value = data.pejabat.bendahara.nip;
            }
        }

        // --- CARI & SIMPAN (AUTO AUTH) ---
        function cariData() {
            let no = document.getElementById('no_bukti').value;
            if(!no) return alert("Isi No Bukti!");
            
            let btn = document.querySelector('.btn-search'); btn.innerText = "‚åõ";
            // Kirim Password di URL
            fetch(API_URL + "?action=search&no=" + encodeURIComponent(no) + "&password=" + encodeURIComponent(USER_TOKEN))
            .then(res => res.json())
            .then(resp => {
                btn.innerText = "üîç Cari";
                if(resp.status === "found") {
                    let d = resp.data;
                    $('#kode_kegiatan').val(d.kode_kegiatan).trigger('change');
                    $('#kode_barang').val(d.kode_barang).trigger('change');
                    document.getElementById('terima_dari').value = d.terima_dari;
                    document.getElementById('nominal').value = d.nominal;
                    document.getElementById('terbilang').value = d.terbilang;
                    document.getElementById('untuk_pembayaran').value = d.untuk_pembayaran;
                    document.getElementById('tanggal_lunas').value = d.tanggal_lunas;
                    
                    if ($('#nama_penerima').find("option[value='" + d.nama_penerima + "']").length) {
                        $('#nama_penerima').val(d.nama_penerima).trigger('change');
                    } else {
                        $('#nama_penerima').append(new Option(d.nama_penerima, d.nama_penerima, true, true)).trigger('change');
                    }
                    alert("Data ditemukan! Silakan edit.");
                } else { alert("Data tidak ditemukan."); }
            });
        }

        function handleForm(e) {
            e.preventDefault();
            let btn = document.querySelector('.btn-save');
            let loading = document.getElementById('loadingText');
            
            // Validasi
            let valKeg = $('#kode_kegiatan').val(); let valBar = $('#kode_barang').val(); let valPen = $('#nama_penerima').val();
            if(!valKeg || !valBar || !valPen) return alert("Lengkapi semua data!");

            // Update Preview Cetak
            document.getElementById('p_no').innerText = document.getElementById('no_bukti').value;
            document.getElementById('p_kegiatan_kode').innerText = valKeg;
            document.getElementById('p_barang').innerText = valBar;
            document.getElementById('p_terima').innerText = document.getElementById('terima_dari').value;
            document.getElementById('p_nominal').innerText = new Intl.NumberFormat('id-ID').format(document.getElementById('nominal').value);
            document.getElementById('p_terbilang').innerText = document.getElementById('terbilang').value;
            document.getElementById('p_untuk').innerText = document.getElementById('untuk_pembayaran').value;
            
            let tglRaw = document.getElementById('tanggal_lunas').value;
            let tglCantik = formatTanggalIndo(tglRaw);
            document.getElementById('p_tgl_1').innerText = tglCantik;
            document.getElementById('p_tgl_2').innerText = tglCantik;
            document.getElementById('p_penerima').innerText = valPen;

            document.getElementById('lbl_nama_kepala').innerText = document.getElementById('input_nama_kepala').value;
            document.getElementById('lbl_nip_kepala').innerText = "NIP. " + document.getElementById('input_nip_kepala').value;
            document.getElementById('lbl_nama_bendahara').innerText = document.getElementById('input_nama_bendahara').value;
            document.getElementById('lbl_nip_bendahara').innerText = "NIP. " + document.getElementById('input_nip_bendahara').value;

            // Kirim ke Server
            btn.disabled = true; loading.style.display = 'block';
            let formData = new FormData(document.getElementById('kuitansiForm'));
            formData.set('kode_kegiatan', valKeg);
            formData.set('kode_barang', valBar);
            formData.set('nama_penerima', valPen);
            formData.set('tanggal_lunas', tglCantik);

            // URL + PASSWORD
            fetch(API_URL + "?password=" + encodeURIComponent(USER_TOKEN), { method: 'POST', body: formData })
            .then(res => res.json())
            .then(response => {
                loading.style.display = 'none'; btn.disabled = false;
                if(response.result === 'success') {
                    if(response.mode === "Update") alert("Data Terupdate!");
                    window.print();
                    resetForm(response.nextNo);
                    forceSync(); 
                } else { alert("Gagal: " + response.error); }
            })
            .catch(err => { alert("Error Jaringan"); loading.style.display = 'none'; btn.disabled = false; });
        }

        function resetForm(nextNo) {
            $('#kode_kegiatan').val(null).trigger('change');
            $('#kode_barang').val(null).trigger('change');
            $('#nama_penerima').val(null).trigger('change');
            document.getElementById('nominal').value = "";
            document.getElementById('terbilang').value = "";
            document.getElementById('untuk_pembayaran').value = "";
            document.getElementById('no_bukti').value = nextNo;
            document.getElementById('terima_dari').value = defaultTerimaDari;
            document.getElementById('tanggal_lunas').valueAsDate = new Date();
        }

        // HELPER FUNCTIONS
        function formatTanggalIndo(isoDate) {
            if(!isoDate) return "";
            const dp = isoDate.split("-");
            const bln = ["", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            return `${dp[2]} ${bln[parseInt(dp[1])]} ${dp[0]}`;
        }
        function updateTerbilang() { document.getElementById('terbilang').value = terbilang(document.getElementById('nominal').value) + " Rupiah"; }
        function terbilang(a){ var bil=['','Satu','Dua','Tiga','Empat','Lima','Enam','Tujuh','Delapan','Sembilan','Sepuluh','Sebelas']; var kal=""; var ang=Math.abs(a); if(ang<12){kal=" "+bil[ang];} else if(ang<20){kal=terbilang(ang-10)+" Belas";} else if(ang<100){kal=terbilang(Math.floor(ang/10))+" Puluh"+terbilang(ang%10);} else if(ang<200){kal=" Seratus"+terbilang(ang-100);} else if(ang<1000){kal=terbilang(Math.floor(ang/100))+" Ratus"+terbilang(ang%100);} else if(ang<1000000){kal=terbilang(Math.floor(ang/1000))+" Ribu"+terbilang(ang%1000);} else if(ang<1000000000){kal=terbilang(Math.floor(ang/1000000))+" Juta"+terbilang(ang%1000000);} return kal; }
    </script>
</body>
</html>
